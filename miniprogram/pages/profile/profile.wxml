<!-- pages/profile/profile.wxml -->
<view class="container">
  <!-- 用户信息部分 -->
  <view class="user-info">
    <image class="avatar" src="{{user.avatarUrl || '/assets/default-avatar.png'}}"></image>
    <view class="user-details">
      <text class="nick-name">{{user.nickName || '未设置昵称'}}</text>
      <text class="username">用户名: {{user.username || '未设置'}}</text>
      <button class="edit-username-btn" bindtap="openEditUsernameModal">修改用户名</button>
    </view>
  </view>

  <!-- 用户创建的项目 -->
  <view class="projects-section">
    <text class="section-title">您创建的项目</text>
    <block wx:for="{{createdProjects}}" wx:key="_id">
      <view class="project-card" bindtap="goToDetail" data-id="{{item._id}}">
        <view class="project-info">
          <text class="project-name">{{item.name}}</text>
          <text class="project-description">{{item.description}}</text>
          <view class="project-details">
            <text class="member-count">参与人数: {{item.participantCount}}</text>
            <text class="publish-time">发布于{{item.createdAtFormatted}}</text>
          </view>
          <view class="project-status">
            <icon type="{{getStatusIcon(item.status)}}" size="16" color="{{getStatusColor(item.status)}}"></icon>
            <text class="status-text">{{item.status}}</text>
          </view>
        </view>
        <view class="project-actions">
          <!-- 仅项目创建者可以删除项目 -->
          <button bindtap="deleteProject" data-id="{{item._id}}" class="delete-btn">删除项目</button>
        </view>
      </view>
    </block>
    <view wx:if="{{createdProjects.length === 0}}" class="no-projects">
      <text>您尚未创建任何项目。</text>
    </view>
  </view>

  <!-- 用户加入的项目 -->
  <view class="projects-section">
    <text class="section-title">您加入的项目</text>
    <block wx:for="{{joinedProjects}}" wx:key="_id">
      <view class="project-card" bindtap="goToDetail" data-id="{{item._id}}">
        <view class="project-info">
          <text class="project-name">{{item.name}}</text>
          <text class="project-description">{{item.description}}</text>
          <view class="project-details">
            <text class="member-count">参与人数: {{item.participantCount}}</text>
            <text class="publish-time">发布于{{item.createdAtFormatted}}</text>
          </view>
          <view class="project-status">
            <icon type="{{getStatusIcon(item.status)}}" size="16" color="{{getStatusColor(item.status)}}"></icon>
            <text class="status-text">{{item.status}}</text>
          </view>
        </view>
        <view class="project-actions">
          <button bindtap="exitProject" data-id="{{item._id}}" class="exit-btn">退出项目</button>
        </view>
      </view>
    </block>
    <view wx:if="{{joinedProjects.length === 0}}" class="no-projects">
      <text>您尚未加入任何项目。</text>
    </view>
  </view>

  <!-- 设置用户名弹窗 -->
  <view wx:if="{{showUsernameModal}}" class="modal-overlay">
    <view class="modal">
      <text class="modal-title">设置用户名</text>
      <input
        class="username-input"
        placeholder="请输入用户名"
        bindinput="handleUsernameInput"
        value="{{usernameInput}}"
      ></input>
      <view class="modal-buttons">
        <button class="cancel-btn" bindtap="cancelUsername">取消</button>
        <button class="confirm-btn" bindtap="submitUsername">确定</button>
      </view>
    </view>
  </view>

  <!-- 修改用户名弹窗 -->
  <view wx:if="{{showEditUsernameModal}}" class="modal-overlay">
    <view class="modal">
      <text class="modal-title">修改用户名</text>
      <input
        class="username-input"
        placeholder="请输入新用户名"
        bindinput="handleEditUsernameInput"
        value="{{newUsername}}"
      ></input>
      <view class="modal-buttons">
        <button class="cancel-btn" bindtap="closeEditUsernameModal">取消</button>
        <button class="confirm-btn" bindtap="submitEditUsername">确定</button>
      </view>
    </view>
  </view>
</view>
